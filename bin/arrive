#!/bin/bash

HOME="$(cd;pwd)"
CONFIG_PATH="$HOME/.config"

LINKED_FILES=(
  pylintrc
  zshrc
  gitconfig
)

PROGRAMS=(
  zsh
  vim
  screen
  neovim
  git
  gcc
  g++
  python3
  python3-pip
  direnv
  wget
  hlint
  mdl
)

PYTHON_PACKS=(
  setuptools
  virtualenv
  flask
  numpy
  pandas
  tensorflow
  https://github.com/joh/when-changed/archive/master.zip
)

HASKELL_PACKS=(
  base
  hoogle
  parallel
  hspec
)

NPM_PACKS=(
  marked
  mocha
  react
  underscore
)

# Install programs
if [[ "$OSTYPE" == "darwin"* ]]; then
  if hash brew 2>/dev/null; then
    echo "Brew installed"
  else
    echo "Installing Brew"
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  fi

  echo "Installing Software"
  brew install --appdir="/Applications" ${PROGRAMS[*]}

  echo "Installing Mac specific programs"
  brew cask install homebrew/cask/alfred
else
  echo "Updating Apt"
  sudo apt-get update

  echo "Installing Software"
  sudo apt-get -f install ${PROGRAMS[*]}
fi

# Install oh-my-zsh
sh -c "$(wget https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -)"

# Install our dotfiles
echo "Linking Dot-files"
for FILE in "${LINKED_FILES[@]}"
do
    mv ".$FILE" "old_$FILE"
    ln $(echo "$CONFIG_PATH/$FILE") $(echo "$HOME/.$FILE")
done

git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
git clone https://github.com/zsh-users/zsh-completions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-completions

# Install plug
curl -fLo ~/.local/share/nvim/site/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

nvim +PlugInstall

echo "Installing Python Libraries"
pip install --upgrade pip
pip install ${PYTHON_PACKS[@]}

echo "Install NPM Packages"
wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash
source ~/.nvm/nvm.sh
nvm install node
npm update
npm install ${NPM_PACKS[@]} -g

echo "Starting zsh"
sudo chsh "$(whoami)" -s "$(which zsh)"
zsh
